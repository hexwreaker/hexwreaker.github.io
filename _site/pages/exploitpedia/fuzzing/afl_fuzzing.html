<!DOCTYPE html>
<html lang="en">
<head class="page-header" role="banner">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexwreaker Expoitpedia</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <canvas id="container"></canvas>
    <script src="/script.js"></script>

    <div id="main" class="main-content" role="main">
        <div id="nav-bar">
            <div id="nav-home" class="nav-item"><a href="/"><img src="/src/images/home.jpg"/></a></div>
        </div>
        <h4 id="exploitpedia"><a href="/pages/exploitpedia/exploitpedia">ExploitPedia</a></h4>

<h1 id="fuzzing-with-afl">Fuzzing with AFL</h1>

<ol>
  <li>see the <a href="https://www.youtube.com/playlist?list=PLhixgUqwRTjy0gMuT4C3bmjeZjuNQyqdx">tutorial videos from “liveoverflow”</a></li>
  <li><a href="https://github.com/google/AFL">American fuzzing lop</a></li>
  <li><a href="https://github.com/AFLplusplus/AFLplusplus">Maintained project AFL++</a></li>
</ol>

<h2 id="présentation">Présentation</h2>

<p>Le <strong>fuzzing</strong> est une technique pour <a href="https://fr.wikipedia.org/wiki/Test_(informatique)" title="Test (informatique)">tester</a> des <a href="https://fr.wikipedia.org/wiki/Logiciel" title="Logiciel">logiciels</a>. L’idée est d’injecter des <a href="https://fr.wikipedia.org/wiki/Variable_al%C3%A9atoire" title="Variable aléatoire">données aléatoires</a> dans les entrées du programme cible et d’observer son comportement et les données en sortie. Si le programme échoue (par exemple en plantant ou en générant une erreur), alors il y a un bug.</p>

<h2 id="american-fuzzy-lop">American Fuzzy Lop</h2>

<p>AFL (sa version maintenue est AFL++) est un fuzzer simple d’utilisation qui permet de réaliser des tests en <strong>black-box</strong> mais aussi en <strong>white-box</strong>. En effet, sa stratégie est d’instrumenter la cible afin d’analyser son comportement interne en fonction des entrées données.
Les tests en <strong>white-box</strong> sont plus efficace  mais nécessite de compiler la cible</p>

<h2 id="utilisation">Utilisation</h2>

<h4 id="instrumentation">Instrumentation</h4>

<p>Le programme cible est un binaire dont le code source n’est pas connue ce qui nous empêche d’instrumenter la cible afin d’utiliser AFL++ en mode <strong>white-box</strong>.
Cepandant, il est possible de décompiler la cible avec Ida Pro et de récupérer le code source généré afin de le recompiler avec <strong>afl-clang-fast</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>File -&gt; Produce file -&gt; Create C file
</code></pre></div></div>

<p>Le code source généré ressemble contient beaucoup de fonctions systèmes qui sont ajouté à la compilation et certaines autres références qu’il convient de retirer. Pour cela, nous avons écris un script python (<em>sanitize_ida_c_file.py</em>) qui permet de “nettoyer” le code généré afin de le rendre compilable, moyennant quelques correction de problèmes. 
Voici le code généré :</p>

<p><img src="/src/images/Pasted image 20250119013033.png" alt="image" /></p>

<p>À présent, il est possible d’instrumenter la cible :</p>

<p><img src="/src/images/Pasted image 20250119013452.png" alt="image" /></p>

<p>L’instrumentation d’AFL consiste à ajouter des instructions qui permettent de suivre l’exécution de la cible.</p>

<p><img src="/src/images/Pasted image 20250119013837.png" alt="image" />
<img src="/src/images/Pasted image 20250119014530.png" alt="image" /></p>

<h4 id="cas-de-tests">Cas de tests</h4>

<p>Avant  de lancer le fuzzer, il faut définir un cas initial pour lequel l’exécution réussi. C’est à partir de ce cas qu’AFL++ va muter les donnéees afin de trouver d’autres chemins.</p>

<p>Le cas initial peut être : 
<img src="/src/images/Pasted image 20250119015105.png" alt="image" /></p>

<h4 id="fuzzing-simple">Fuzzing simple</h4>

<p>AFL++ va exécuter la cible avec des données différentes à chaque fois, qui sont mutées à partir du cas initial.
Lorsqu’une exécution “crash”, AFL journalise le cas dans le dossier de sortie.</p>

<p>Le lancement du fuzzing se fait avec la commande suivante :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>afl-fuzz -m none -i in/ -o out3/ -- ./mych6_afl
</code></pre></div></div>

<p>Un crash est survenu :</p>

<p><img src="/src/images/Pasted image 20250130114427.png" alt="image" /></p>

<p>Il n’existe pas de mode multithread mais Il est possible d’exécuter afl++ sur plusieurs coeurs en utilisant plusieurs processus.
Voici un script shell qui lance un processus “maître” suivi de 26 processus “esclaves” :</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nb">export </span><span class="nv">AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES</span><span class="o">=</span>1
<span class="nb">export </span><span class="nv">AFL_SKIP_CPUFREQ</span><span class="o">=</span>1

<span class="c"># master</span>
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-M</span> fuzz01 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span>
<span class="c"># slaves</span>
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz02 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz03 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz04 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz05 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz06 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz07 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz08 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz09 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz10 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz11 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz12 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz13 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz14 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz16 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz17 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz18 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz19 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz20 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz21 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz22 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz23 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz24 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz25 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz26 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz27 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null
<span class="o">(</span>afl-fuzz <span class="nt">-m</span> none <span class="nt">-i</span> <span class="k">in</span>/ <span class="nt">-o</span> out2/ <span class="nt">-S</span> fuzz28 <span class="nt">--</span> ./mych6_afl &amp;<span class="o">)</span> 1&gt;/dev/null

<span class="nb">wait</span>
</code></pre></div></div>

<h5 id="analyse-des-résultats">Analyse des résultats</h5>

<p>Le fuzzing ne garantit pas de découvrir tous les bugs dans un programme, et ce, quel que soit le temps que l’on alloue.
Une fois que l’on décide de stopper AFL++, on peut analyser les résultats obtenues dans le dossier <strong><em>“out2”</em></strong>.</p>

<p>Il est possible de lire les statistiques du fuzzing :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	$ cat ./out2/default/fuzzer_stats
</code></pre></div></div>

<p>On obtient, entre autres, les stats suivantes :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>start_time        : 1738233791  
last_update       : 1738234141  
execs_done        : 23922  
execs_per_sec     : 68.48  
...
max_depth         : 2  
stability         : 100.00%  
bitmap_cvg        : 35.96%  
saved_crashes     : 1  
saved_hangs       : 11  
last_find         : 1738234064  
last_crash        : 1738233847  
last_hang         : 1738234061  
...
afl_banner        : ./mych6_afl  
afl_version       : ++4.21c  
command_line      : afl-fuzz -m none -i in/ -o out3/ -- ./mych6_afl
</code></pre></div></div>

<p>Les données utilisée lors du “crash” ont été sauvegardées dans <strong><em>”./out3/default/crashes/”</em></strong></p>

<p><img src="/src/images/Pasted image 20250130120248.png" alt="image" /></p>

<p>Il faut s’assurer que le programme originale crash aussi, en effet il se peut que l’instrumentation d’AFL++ a modifier le code.</p>

<p>Malheureusement la cible ne crash pas en conditions réelles. Snif…</p>

<h4 id="fuzzing-avec-harnais">Fuzzing avec harnais</h4>

<p>À expliquer…</p>


    </div>
</body>
</html>
