<!DOCTYPE html>
<html lang="en">
<head class="page-header" role="banner">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexwreaker Expoitpedia</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <canvas id="container"></canvas>
    <script src="/script.js"></script>

    <div id="main" class="main-content" role="main">
        <div id="nav-bar">
            <div id="nav-home" class="nav-item"><a href="/"><img src="/src/images/home.jpg"/></a></div>
        </div>
        <h4 id="exploitpedia"><a href="/pages/exploitpedia/exploitpedia">ExploitPedia</a></h4>

<h1 id="format-strings-precision-writing">Format strings precision writing</h1>

<h2 id="présentation">Présentation</h2>

<p>voir : <a href="/pages/exploitpedia/format_strings/format_strings_overflow">Format string</a></p>

<p>Il est possible d’écrire à un endroit précis dans la mémoire en utilisant le formatteur : <strong>“%n”</strong> et <strong>“%hn”</strong> (sa variante pour 2 octets).
Ils permettent d’écrire le nombre <strong>N</strong> de caractères précédemment affichés à l’endroit pointé par l’argument.</p>

<p>Par exemple, pour écrire la valeur <strong>0x080484cb</strong> à l’adresse <strong>0x080498ae</strong> :</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pld</span>  <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x080498ae</span><span class="p">)</span>
<span class="n">pld</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x080498ac</span><span class="p">)</span>
<span class="n">pld</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"%2044x%4$hn"</span>      <span class="c1"># écrit la valeur  2044+8    (0x0804) dans 0x080498ae
</span><span class="n">pld</span> <span class="o">+=</span> <span class="sa">b</span><span class="s">"%31943x%5$hn"</span>     <span class="c1"># écrit la valeur 31943+2052 (0x84cb) dans 0x080498ac
</span></code></pre></div></div>

<h1 id="exemple">Exemple</h1>

<p>Pour ce qui est de l’environnement d’exploitation, il n’y a aucune protections. L’exploitation est réalisée à distance, en envoyant un payload. La taille de la chaîne formattée <strong>output</strong> ne peut pas dépassé 1023 octets, ce qui impose à l’attaquant de s’adapter.</p>

<p>L’objectif est de réecrire une adresse de la section <strong>got.plt</strong>. qui pointe vers le shellcode en pile. La fonction réecrite choisie est : <strong>send()</strong>. Cette technique s’appelle : <a href="/pages/exploitpedia/techniques/got_overwriting">Got overwriting</a>.</p>

<p>Le payload comprend d’abord les adresses des 4 octets de la got.plt de <strong>send()</strong>. La taille maximale de 1023 octets force l’attaquant à réecrire octet par octet la cible, en utilisant le formateur <strong>%hhn</strong> et non pas <strong>%n</strong>.</p>

<p>Ensuite il y a les formateurs :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%1$Xid %Y$hhn
</code></pre></div></div>

<p>dont la première partie consiste à écrire Xi caractères et la seconde à écrire le nombre de caractère total écrit depuis le début à l’adresse du Yème argument.</p>

<p>Puis vient le shellcode précédé d’un NOPsled. Le shellcode consiste à converger les entrées et sorties standards (<strong>stdin, stdout, stderr</strong>) vers le socket du client (<strong>csock</strong>) avant d’appeler <strong>execve(“/bin//sh”)</strong>.</p>


    </div>
</body>
</html>
